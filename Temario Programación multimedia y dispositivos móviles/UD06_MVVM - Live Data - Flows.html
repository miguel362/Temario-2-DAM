
<!-- saved from url=(0064)https://sdram58.github.io/apuntesPMDM/unidades2223/ud6_mvvm.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body class="line-numbers">k


    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVVM - Live Data - Flows</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://sdram58.github.io/apuntesPMDM/favicon.ico">
    <link rel="stylesheet" href="./MVVM - Live Data - Flows_files/prism.css">
    <link rel="stylesheet" href="./MVVM - Live Data - Flows_files/styles.css">
    <script src="./MVVM - Live Data - Flows_files/script.js.descarga"></script>


    <h1>UD6.- MVVM - Live Data - Flows</h1>
    <div class="main-menu">
        <div class="fila">
            <a href="https://sdram58.github.io/apuntesPMDM/unidades2223/ud6_mvvm.html#sMVVM">MVVM</a><a href="https://sdram58.github.io/apuntesPMDM/unidades2223/ud6_mvvm.html#sLiveData">Live Data</a><a href="https://sdram58.github.io/apuntesPMDM/unidades2223/ud6_mvvm.html#sFlows">Flows</a>
        </div>
        <div class="fila">
            <a href="https://sdram58.github.io/apuntesPMDM/unidades2223/ud6_mvvm.html#sWebGraphy">WebGraphy</a>
            <a class="relleno"></a>
            <a class="relleno"></a>
        </div>
    </div>

    


    <!--*********************************************************MODEL - VIEW - VIEWMODEL (MVVM)***********************************************************-->
    <section class="apartado">
    <a name="sMVVM"></a>
    <h2>MODEL - VIEW - VIEWMODEL (MVVM)</h2>
    
    <p>This practice is the first start or contact with the <span class="r-word">Model-View-ViewModel</span>  architecture, recommended for developing apps.</p>

    <p>We will explore the benefits this architecture provides, and the problems it solves.</p>
    
    <p>We will use the <span class="r-word">ViewModel</span>  and <span class="r-word">LiveData</span> classes.</p>
    
    <p>We will develop an app that consists of a <span class="d-word">Body Mass Index Calculator</span> </p>

    <figure><img src="./MVVM - Live Data - Flows_files/ud6_running_app_calculator.gif"><br><figcaption>Running App</figcaption></figure>
    <br>

    <h3>Creating the project</h3>
    
 <ul>
     <li>Select <span class="negrita">Empty Activity</span>  as the template.</li>
     <li><span class="subrayado">Add dependencies</span>  for ViewModel and LiveData support; also for Navigation and Coroutines.
    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita"> build.gradle (Module: app)</span>
        </section>
    <section class="marco-b">
            <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">def viewModelVersion <span class="token operator">=</span><span class="token string">"2.5.1"</span>
def navVersion <span class="token operator">=</span> <span class="token string">"2.5.3"</span>
implementation <span class="token string">"androidx.navigation:navigation-fragment-ktx:<span class="token interpolation variable">$navVersion</span>"</span>
implementation <span class="token string">"androidx.navigation:navigation-ui-ktx:<span class="token interpolation variable">$navVersion</span>"</span>


implementation <span class="token string">"androidx.lifecycle:lifecycle-viewmodel-ktx:<span class="token interpolation variable">$viewModelVersion</span>"</span>
implementation <span class="token string">"androidx.lifecycle:lifecycle-livedata-ktx:<span class="token interpolation variable">$viewModelVersion</span>"</span>

implementation <span class="token string">"org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.4"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
            </section>
    </section>
    </li>

    <li>Enable ViewBinding

    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita"> build.gradle (Module: app)</span>
        </section>
    <section class="marco-b">
          <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">android <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    buildFeatures <span class="token punctuation">{</span>
        viewBinding <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
          </section>
    </section>
    </li>

    <li>Create the Navigation Graph <span class="inline-file">res/navigation/nav_graph.xml</span>
    <br><br>Add <span class="r-word">NavHostFragment</span>  to the <span class="r-word">MainActivity</span> layout:

    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita">res/layout/activity_main.xml</span>
        </section>
    <section class="marco-b">
          <section><div class="code-toolbar"><pre class="language-xml line-numbers" tabindex="0"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.constraintlayout.widget.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.fragment.app.FragmentContainerView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>androidx.navigation.fragment.NavHostFragment<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/nav_host_fragment<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>defaultNavHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>navGraph</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@navigation/nav_graph<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>androidx.constraintlayout.widget.ConstraintLayout</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
          </section>
    </section>
    </li>

    <li>Create a destination on the <span class="inline-file">nav_graph.xml</span> called <span class="d-word">BMIFragment</span>
    
    <br><br>Configure <span class="r-word">ViewBinding</span> :
    
    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita">BMIFragment.kt</span>
        </section>
    <section class="marco-b">
        <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-class">class</span> BMIFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
        <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> binding<span class="token operator">:</span> FragmentBMIBinding
    
    
        <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>
            inflater<span class="token operator">:</span> LayoutInflater<span class="token punctuation">,</span> container<span class="token operator">:</span> ViewGroup<span class="token operator">?</span><span class="token punctuation">,</span>
            savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span>
        <span class="token punctuation">)</span><span class="token operator">:</span> View<span class="token operator">?</span> <span class="token punctuation">{</span>
            <span class="token comment">// Inflate the layout for this fragment</span>
            <span class="token keyword keyword-return">return</span> FragmentBMIBinding
                <span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>inflater<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> binding <span class="token operator">=</span> it <span class="token punctuation">}</span><span class="token punctuation">.</span>root
    
        <span class="token punctuation">}</span>
    
        <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section>
        
    </section>
</li>
    <li>Add the following Views to the Layout
        <section class="marco-t file-">
            <span class="icono file"> </span> <span class="negrita">res/layout/fragment_b_m_i.xml</span>
            </section>
        <section class="marco-b">
             <section><div class="code-toolbar"><pre class="language-xml line-numbers" tabindex="0"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.constraintlayout.widget.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LinearLayout</span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>orientation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>vertical<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>padding</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>20dp<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EditText</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/etWeight<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>hint</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Weight in Kg<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EditText</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/etHeight<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>hint</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Height in cm<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/btnCalculate<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>calculate body mass index<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
            <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/tvBMI<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>26sp<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>textColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/purple_500<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ScrollView</span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
                <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris finibus nibh a pretium mattis. Nulla facilisi. Aliquam volutpat tincidunt orci ac volutpat. Donec sit amet aliquam nisl, sed sollicitudin nibh. Suspendisse potenti. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Maecenas velit nunc, tempus vitae lectus ut, pellentesque dapibus libero. Etiam laoreet quam sem, sit amet pharetra elit rhoncus quis. Sed hendrerit ac enim vel eleifend. Suspendisse potenti. Nullam eleifend, augue id condimentum bibendum, enim nibh accumsan diam, eu gravida odio turpis rutrum mi. Integer ullamcorper enim diam, vitae pharetra ex ultricies vel. Vivamus lacinia non mauris id blandit. Donec varius rhoncus mauris, vel luctus nibh volutpat at. Morbi turpis dolor, scelerisque vel quam sit amet, ultricies mattis eros. Etiam nisl risus, imperdiet vitae vestibulum faucibus, vehicula eu mauris. Vestibulum bibendum luctus ipsum at rhoncus. Nam sodales metus at turpis porttitor efficitur. Sed dui nisl, viverra in massa vitae, vestibulum bibendum tellus. Phasellus suscipit risus est, vitae hendrerit nunc rhoncus ut. Aenean commodo venenatis lacinia. Nunc fermentum felis ligula, ut placerat metus vulputate ullamcorper. Donec metus diam, aliquet vitae nulla nec, blandit placerat sem. Cras tempus tincidunt velit in pulvinar. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Praesent nec risus eget augue viverra sollicitudin. Maecenas volutpat nunc vel orci rutrum, ac mollis elit sollicitudin. Nulla eget tempor turpis. Curabitur bibendum dapibus metus, sit amet viverra justo imperdiet ac. Duis facilisis sem libero, ut rutrum ipsum pellentesque laoreet.<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ScrollView</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LinearLayout</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ProgressBar</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/progress_circular<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>visibility</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gone<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintBottom_toBottomOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintEnd_toEndOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintStart_toStartOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>layout_constraintTop_toTopOf</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>androidx.constraintlayout.widget.ConstraintLayout</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
             </section><br><br>   
        </section>

        <figure><img src="./MVVM - Live Data - Flows_files/ud6_2021-11-08-12-51-20.png"><br><figcaption></figcaption></figure>
        
    </li>

 </ul>

    <h3>BMI Calculator</h3>
    <p>The app that we are going to develop consists of the user entering a weight in kg and a height in cm. The app will determine what your body mass index is.</p>
    
    <p>This funcionality is implemented by <span class="d-word">BMICalculator</span>  class</p>
    
    <p>The <span class="d-word">BMICalculator</span>  class contains the calculate method that receives as a parameter a 
        <span class="d-word">Request</span>  object with the requested <span class="d-word">weight</span>  and <span class="d-word">height</span>
        fields, and calculates the <span class="negrita">bmi (Body Mass Index)</span>. Weight/Height<sup>2</sup></p>
    <p>A pause (<span class="r-word">sleep ()</span> ) has been added to simulate obtaining the imc through a long operation, such as accessing a database, a server, etc.</p>
    
    <p>Create this class:</p>
    
    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita">BMICalculator.kt</span>
        </section>
    <section class="marco-b">
       <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-class">class</span> BMICalculator<span class="token punctuation">{</span>

    <span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">Request</span><span class="token punctuation">(</span>
        <span class="token keyword keyword-val">val</span> weight<span class="token operator">:</span>Double<span class="token punctuation">,</span>
        <span class="token keyword keyword-val">val</span> height<span class="token operator">:</span>Double
    <span class="token punctuation">)</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">calcMBI</span><span class="token punctuation">(</span>weight<span class="token operator">:</span> Double<span class="token punctuation">,</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span><span class="token operator">:</span>Double <span class="token operator">=</span> weight<span class="token operator">/</span> <span class="token punctuation">(</span>height<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-fun">fun</span> <span class="token function">calculate</span><span class="token punctuation">(</span>request<span class="token operator">:</span>Request<span class="token punctuation">)</span><span class="token operator">:</span>Double<span class="token punctuation">{</span>

        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> <span class="token function">calcMBI</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> request<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section></section>


    <h3>Crashes, Data Loss, and Memory Leaks</h3>

<p>When developing an Android app, a common mistake is writing all the code in an Activity or Fragment.</p>

<p>For example, in this method of the <span class="inline-file">BMIFragment</span> class we might be tempted to do the following:</p>

<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">BMIFragment.kt</span>
    </section>
<section class="marco-b">
       <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"> <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>
    binding<span class="token punctuation">.</span>btnCalculate<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>


        binding<span class="token punctuation">.</span>progressCircular<span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>VISIBLE

        <span class="token keyword keyword-val">val</span> bmiCalculator <span class="token operator">=</span> <span class="token function">BMICalculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> mHeight <span class="token operator">=</span> binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> mWeight <span class="token operator">=</span> binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-val">val</span> bmi <span class="token operator">=</span> bmiCalculator<span class="token punctuation">.</span><span class="token function">calculate</span><span class="token punctuation">(</span>BMICalculator<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>mWeight<span class="token punctuation">,</span> mHeight<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> dec <span class="token operator">=</span> <span class="token function">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">"#,###.00"</span><span class="token punctuation">)</span>

        binding<span class="token punctuation">.</span>tvBMI<span class="token punctuation">.</span>text <span class="token operator">=</span> dec<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>bmi<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        binding<span class="token punctuation">.</span>progressCircular<span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>GONE
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section>
</section>

<p>In code above we can see that when we push the button <span class="d-word">btnCalculate</span> we obtain the <span class="negrita">weight</span> 
    and the <span class="negrita">height</span> introduced by the user. Then calls <span class="d-word">calculate</span> method from <span class="d-word">BMICalculator</span>  and then set de bmi on the 
<span class="r-word">textView</span>  </p>

<p class="sub-section">Blocking</p>

<p>If you run the app, it may appear to be working properly. However there are several problems.</p>

<p>The first is that the User Interface (View) has been blocked for as long as the <span class="d-word"> calculate()</span> method has been executing.</p>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-13-21-31.png"><br><figcaption></figcaption></figure>
<br>

<p>Due to the UI crash, we would not have been able to show, for example, a progress bar, or scroll our scroll view, or perhaps give the user the option to 
    cancel the operation... What's more, if the operation takes more than 5 seconds and the user tries After interacting with the User Interface in the meantime, 
    the Android system will show you the infamous "<span class="cursiva">
        <a class="enlace" target="_blank" href="https://developer.android.com/training/articles/perf-anr">application is not responding</a></span>" dialog.</p>

<section class="marco-t err">
    <span class="icono error"> </span> Long-lived operations should not be performed on the UI thread.
    </section>
<section class="marco-b">
        
</section>

<p>One solution that was widely used for some time was the use of the <span class="r-word">AsyncTask</span> java class, to run long-running tasks in the background.
    It used to be something like this:</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-class">class</span> DownloadFilesTask extends AsyncTask<span class="token operator">&lt;</span>URL<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> Long<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
     <span class="token keyword keyword-protected">protected</span> Long <span class="token function">doInBackground</span><span class="token punctuation">(</span>URL<span class="token operator">..</span><span class="token punctuation">.</span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         int count <span class="token operator">=</span> urls<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
         long totalSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             totalSize <span class="token operator">+=</span> Downloader<span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span>urls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">publishProgress</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token punctuation">(</span>float<span class="token punctuation">)</span> count<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">// Escape early if cancel() is called</span>
             <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword keyword-return">return</span> totalSize<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword keyword-protected">protected</span> void <span class="token function">onProgressUpdate</span><span class="token punctuation">(</span>Integer<span class="token operator">..</span><span class="token punctuation">.</span> progress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">setProgressPercent</span><span class="token punctuation">(</span>progress<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword keyword-protected">protected</span> void <span class="token function">onPostExecute</span><span class="token punctuation">(</span>Long result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">showDialog</span><span class="token punctuation">(</span><span class="token string">"Downloaded "</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">" bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section>

<p>Once created, a task is executed very simply:</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"> new <span class="token function">DownloadFilesTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>url1<span class="token punctuation">,</span> url2<span class="token punctuation">,</span> url3<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section>

<p><a class="enlace" target="_blank" href="https://developer.android.com/reference/android/os/AsyncTask">More Info about AsyncTask</a></p>
 
<p>The intention of using <span class="r-word">AsyncTask</span>  is to run the <span class="d-word">calculate()</span>  method on a background task, and update the <span class="r-word">TextView</span>  with the quota obtained when the task ends.</p>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-13-32-25.png"><br><figcaption></figcaption></figure>
<br>

<p>This prevents blocking of the user interface. If you run the app now, you'll see that the UI is still responding even when the long-running
     <span class="d-word">calculate()</span>  task is running.</p>
<p>But this solution doesn't solve all problems either.</p>

<p class="sub-section">Data loss</p>

<p>A characteristic behavior of <span class="negrita">Android</span> is that when the user rotates the mobile screen, <span class="subrayado">the system destroys the running <span class="r-word">Activity</span> </span>,
    and creates a new one with the new screen configuration. With this, all added views (<span class="r-word">Fragments</span> , widgets, etc.) and all variables of the destroyed <span class="r-word">Activity</span>  
    instance are also lost. Furthermore, the layout of the <span class="r-word">Activity</span>  returns to the starting point, as defined in the xml.</p>

<p>So because of this, neither of the above two solutions solves the data loss problem.</p>

<ul>
    <li>
        
<span class="subrayado"><span class="negrita">Without AsyncTask</span></span>  : although the app has survived the crash and the quota has been shown in the <span class="negrita">&lt;TextView&gt;</span>,
 if the user then rotates the mobile, the <span class="d-word">bmi</span>  disappears from the <span class="negrita">&lt;TextView&gt;</span>, when Android destroys the <span class="r-word">Activity</span>  and creates a new one.

 <figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-13-39-45.png"><br><figcaption></figcaption></figure>
 <br>
 
    </li>

    <li>
        <span class="subrayado"><span class="negrita">With AsyncTask</span></span>: even if the app has not crashed during the calculation, 
        the data is still lost if the user rotates the screen.

        <figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-13-40-53.png"><br><figcaption></figcaption></figure>
        <br>
        
    </li>
</ul>

<section class="marco-t warn">
    <span class="icono warning"> </span> You must consider that the <span class="negrita">User Interface does not belong to you</span>  and that the android system can do with it whatever it deems appropriate.
    </section>
<section class="marco-b">
        
</section>

<p class="sub-section">Memory Leaks</p>
<p>We now go to the case that the user rotates the screen just when the calculation is being carried out.</p>

<p>With the program without <span class="r-word">AsyncTask</span>, the behavior of the app will be erratic, since <span class="r-word">Android</span>  cannot destroy the <span class="r-word">Activity</span> 
     or create a new one until the <span class="d-word">calculate()</span>  task has finished.</p>

     <figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-13-50-03.png"><br><figcaption></figcaption></figure>
     <br>
     
<p>With the program with <span class="r-word">AsyncTask</span> , the following happens: when the screen is rotated in the middle of executing the <span class="r-word">AsyncTask</span>, 
    <span class="negrita">Android</span>  will try to destroy the running <span class="d-word">MainActivity</span> (keep in mind that the <span class="d-word">BMIFragment</span>
    fragment is inside the <span class="d-word">MainActivity</span>). However, it will not be able to do so since the <span class="r-word">AsyncTask</span> 
     maintains a reference to the variable <span class="d-word">binding.tvBMI</span>  that belongs to the <span class="d-word">MainActivity</span>. So <span class="negrita">Android</span> 
      will create a new <span class="d-word">MainActivity</span>  without being able to destroy the previous one, which will unnecessarily occupy the system's ram memory. 
      This is a <span class="negrita">Memory Leak</span>.</p>

<p>In addition, when the <span class="d-word">AsyncTask</span> finishes, it will put the resulting <span class="d-word">BMI</span>  in the TextView of the 
     that should have been destroyed and that has been lost in memory, and therefore, it will never be shown in the <span class="r-word">TextView</span>  of the new 
     <span class="d-word">MainActivity</span>  in execution.</p>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-13-55-39.png"><br><figcaption></figcaption></figure>
<br>

<section class="marco-t warn">
    <span class="icono warning"> </span> We have not keep references to UI elements in background tasks.
    </section>
<section class="marco-b">
        
</section>

<p>To alleviate these problems, different procedures have been constantly appearing that involved static <span class="r-word">AsyncTasks</span> , <span class="r-word">WeakReferences</span>,
    overrides of life cycle methods, etc, all of them with their advantages and disadvantages. Currently, it seems that the most accepted solution is to implement the 
    <span class="negrita">MVVM architecture</span>  that we will see below.</p>

<h3>MVVM architecture</h3>

<p>The <span class="r-word">Model-View-ViewModel</span> architecture is based on the Separation of Interests principle, dividing the app code into three categories:</p>

<ul>
    <li><span class="r-word">View</span> : It is in charge of the interaction with the user.</li>
    <li><span class="r-word">Model</span> : It is in charge of carrying out the actions on the data.</li>
    <li><span class="r-word">ViewModel</span> : Acts as a link between the Model and the View.</li>
</ul>

<p>When the View has to perform any action on the data (calculation, query, modification, etc ...) it does not do so directly on the <span class="r-word">Model</span> , but uses the <span class="r-word">ViewModel</span>
    as an intermediary. The <span class="r-word">ViewModel</span> transfers the action to the <span class="r-word">Model</span>. The <span class="r-word">Model</span> 
    responds to the <span class="r-word">ViewModel</span>  with the result of the action (data or errors), and the <span class="r-word">ViewModel</span> passes it back to the View. 
    In Android apps we will implement the <span class="r-word">ViewModel</span>  using the <span class="r-word">AndroidViewModel</span> class.</p>

<p>The key point for decoupling the View from the rest of the app's components, and avoiding so the problems seen in the previous point, 
    is that the <span class="r-word">ViewModel</span> does not directly transfer the result of the actions to the View, but rather the View is the who observes the result. 
    The watch mechanism implies that the ViewModel reports the result to the View, <span class="negrita">only if the View is running</span>. 
    To implement the observation we will use the <span class="r-word">LiveData</span>  class.</p>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-14-25-58.png"><br><figcaption></figcaption></figure>
<br>

<p>Thus, the communication between these components is usually like this:</p>

<ul>
    <li>The <span class="negrita">View</span>  calls methods of the <span class="negrita">ViewModel</span> to perform actions on the data, and watches the 
        <span class="negrita">LiveData</span> to obtain the result.</li>
    
    <li>The <span class="negrita">ViewModel</span>  transfers the actions to the <span class="negrita">Model</span> through method calls (usually in the background), 
        and saves the resulting data in the <span class="negrita">LiveData</span> .</li>

    <li>The <span class="negrita">Model</span> performs the actions on the data and returns the result to the <span class="negrita">ViewModel</span> (with return or through callbacks).</li>
</ul>

<p>Another key aspect is that the <span class="r-word">ViewModel</span> survives screen rotation, so the data stored in the <span class="r-word">ViewModel</span> is not lost when
    <span class="negrita">Android</span>  destroys the View and recreates it.</p>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-14-29-35.png"><br><figcaption></figcaption></figure>
<br>

<h3>MVVM implementation</h3>

<p>To implement a <span class="negrita">ViewModel</span>  in Android you have to create a class and make it extend from the <span class="r-word">AndroidViewModel</span> class.</p>

<p>In this app we will call this class <span class="d-word">BMICalculatorViewModel</span> . In it we do the following:</p>

<ul>
    <li>We declare the variable <span class="d-word">bmi</span>  of type Double wrapped in the <span class="d-word">MutableLiveData</span> class (Mutable allows changing the value of the variable).</li>
    <li>In the class constructor we initialize the Model (<span class="r-word">BMICalculator.kt</span>).</li>
    <li>We define the <span class="d-word">calculate()</span>  method that will be called by the View, and which, in turn, calls the Model's <span class="d-word">calculate()</span> 
        method in the background.</li>
</ul>
<br>

<p>This method receives the data from the View (weight and height), and transforms it into a <span class="d-word">BMICalculator.Request</span>  object to send to the 
    <span class="d-word">Model</span>.</p>

<p>The <span class="d-word">calculate()</span> method of the <span class="negrita">Model</span> is called in the background, and the result 
    bmi is saved in the variable <span class="d-word">bmi</span>  (to change the value of a <span class="r-word">MutableLiveData</span>  within a background task, use the 
    <span class="negrita">postValue()</span>  method).</p>

<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">BMICalculatorViewModel.kt</span>
    </section>
<section class="marco-b">
        
</section>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-class">class</span> BMICalculatorViewModel<span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> bmiCalculator<span class="token operator">:</span> BMICalculator <span class="token operator">=</span> <span class="token function">BMICalculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword keyword-val">val</span> bmi <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>Double<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">calculate</span><span class="token punctuation">(</span>weight<span class="token operator">:</span> Double<span class="token punctuation">,</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//Using coroutine</span>
        <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span> <span class="token comment">//This run in background coroutine</span>
            <span class="token keyword keyword-val">val</span> bmiResult <span class="token operator">=</span> bmiCalculator<span class="token punctuation">.</span><span class="token function">calculateWithFunctions</span><span class="token punctuation">(</span>BMICalculator<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>weight<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>

            bmi<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>bmiResult<span class="token punctuation">)</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br><br>

<p>The View (BMIFragment) for its part does the following:</p>

<ul>
    <li>Gets an instance of the <span class="d-word">BMICalculatorViewModel</span>. To obtain an instance of a <span class="r-word">ViewModel</span> , 
        use the <span class="r-word">ViewModelProvider</span> , passing it the class .class of the <span class="r-word">ViewModel</span>  that you want to obtain.</li>
    <li>When the user clicks the button, the data entered is obtained and the <span class="r-word">ViewModel</span>  is called to execute the <span class="d-word">calculate()</span>
         action with that data.</li>
    <li>The variable <span class="d-word">bmi</span>  (the <span class="negrita">LiveData</span> ) of the <span class="negrita">ViewModel</span>  is observed. 
        When the value of the quota variable changes (that is, the result is set), the <span class="r-word">LiveData</span>  will call the <span class="r-word">onChanged()</span> 
         method, reporting the value of the variable in the <span class="d-word">newBMI</span>  parameter. The only thing that is done is to set this value in the &lt;TextView&gt;.</li>
</ul>

<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">BMIFragment.kt</span>
    </section>
<section class="marco-b">
<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-class">class</span> BMIFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> binding<span class="token operator">:</span> FragmentBMIBinding


    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>
        inflater<span class="token operator">:</span> LayoutInflater<span class="token punctuation">,</span> container<span class="token operator">:</span> ViewGroup<span class="token operator">?</span><span class="token punctuation">,</span>
        savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> View<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token comment">// Inflate the layout for this fragment</span>
        <span class="token keyword keyword-return">return</span> FragmentBMIBinding
            <span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>inflater<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> binding <span class="token operator">=</span> it <span class="token punctuation">}</span><span class="token punctuation">.</span>root

    <span class="token punctuation">}</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>

        <span class="token comment">//Obtaining a reference to our ViewModel</span>
        <span class="token keyword keyword-val">val</span> bmiCalculatorViewModel<span class="token operator">:</span>BMICalculatorViewModel <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">[</span>BMICalculatorViewModel<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">]</span>

        binding<span class="token punctuation">.</span>btnCalculate<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>

            <span class="token function">closeKeyBoard</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token comment">//closing soft keyboard</span>


            <span class="token keyword keyword-var">var</span> mHeight <span class="token operator">=</span> <span class="token number">0.0</span>
            <span class="token keyword keyword-var">var</span> mWeight <span class="token operator">=</span> <span class="token number">0.0</span>

            mHeight <span class="token operator">=</span> binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            mWeight <span class="token operator">=</span> binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            bmiCalculatorViewModel<span class="token punctuation">.</span><span class="token function">calculateBMI</span><span class="token punctuation">(</span>mWeight<span class="token punctuation">,</span>mHeight<span class="token punctuation">)</span>          

        <span class="token punctuation">}</span>

        <span class="token comment">//keep observing change on bmi from viewModel</span>
        bmiCalculatorViewModel<span class="token punctuation">.</span>bmi<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span><span class="token punctuation">{</span> newBMI <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-val">val</span> dec <span class="token operator">=</span> <span class="token function">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">"#,###.00"</span><span class="token punctuation">)</span>

            binding<span class="token punctuation">.</span>tvBMI<span class="token punctuation">.</span>text <span class="token operator">=</span> dec<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>newBMI<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">closeKeyBoard</span><span class="token punctuation">(</span>view<span class="token operator">:</span>View<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token punctuation">(</span>activity<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Activity<span class="token punctuation">.</span>INPUT_METHOD_SERVICE<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> InputMethodManager<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
                <span class="token function">hideSoftInputFromWindow</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span>windowToken<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section></section>

<p>The following diagram illustrates the communication between the 3 components of the app:</p>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-15-34-40.png"><br><figcaption></figcaption></figure>
<br>


<p>The key to why the <span class="r-word">ViewModel</span>  solves the screen rotation problem is in the <span class="r-word">ViewLifecycleOwner</span> parameter passed 
    to the <span class="r-word">observe</span>  method, which ensures that the notification of the result (through the call to <span class="negrita">onChanged()</span> , lambda), will only be made if the View ( the fragment) 
    is still running when the result is obtained.</p>

<p>Suppose that the user presses the calculate button with the mobile vertically, and while the calculation is being carried out rotates the mobile. 
    The fragment that originally performed the <span class="d-word">calculate()</span>  action and <span class="negrita">observed</span> the result will no longer be 
    running and will not be notified of the result. However, the <span class="subrayado">new fragment that has been created</span> and that also <span class="negrita">observes</span> 
     the result will be notified.</p>
<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-08-15-28-37.png"><br><figcaption></figcaption></figure>
<br>

<p class="sub-section">Callbacks</p>

<p>The callback mechanism consists in that when a method is called, it is passed an object in which the methods that it has to call to return the result are defined. 
    In the methods of that object you define what to do with the result.</p>


<p>Communication between the <span class="r-word">ViewModel</span>  and the <span class="r-word">Model</span>  is done through calls and <span class="negrita">callbacks</span>.
    On return calls, the result is reported as well as progress and errors. The <span class="r-word">ViewModel</span>  notifies the <span class="r-word">View</span>  via <span class="r-word">LiveData</span> 
     variables.</p>


<p>In this case we're going to the same using callbacks, functions or sealed class. Notice that callbacks introduce more boling code</p>

<p>Change the <span class="d-word">BMICalculator</span>  class so that it communicates the result through a callback, functions and sealed class:</p>

<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">BMICalculator.kt</span>
    </section>
<section class="marco-b">
<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-package">package</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index<span class="token punctuation">.</span>model


<span class="token keyword keyword-import">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Exception
<span class="token keyword keyword-import">import</span> kotlin<span class="token punctuation">.</span>math<span class="token punctuation">.</span>pow


<span class="token keyword keyword-typealias">typealias</span> OnWrongHeight <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> OnWrongWeight <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> onError <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> OnSuccess <span class="token operator">=</span> <span class="token punctuation">(</span>bmi<span class="token operator">:</span>Double<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> OnLoading <span class="token operator">=</span> <span class="token punctuation">(</span>loading<span class="token operator">:</span>Boolean<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit


<span class="token keyword keyword-class">class</span> BMICalculator<span class="token punctuation">{</span>

    <span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">Request</span><span class="token punctuation">(</span>
        <span class="token keyword keyword-val">val</span> weight<span class="token operator">:</span>Double<span class="token punctuation">,</span>
        <span class="token keyword keyword-val">val</span> height<span class="token operator">:</span>Double
    <span class="token punctuation">)</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">calcMBI</span><span class="token punctuation">(</span>weight<span class="token operator">:</span> Double<span class="token punctuation">,</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span><span class="token operator">:</span>Double <span class="token operator">=</span> weight<span class="token operator">/</span> <span class="token punctuation">(</span>height<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token comment">/***************WITH FUNCTIONS***********************************/</span>
    <span class="token comment">//Long calculating function</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">calculateWithFunctions</span><span class="token punctuation">(</span>request<span class="token operator">:</span>Request<span class="token punctuation">,</span>onSuccess<span class="token operator">:</span> OnSuccess<span class="token punctuation">,</span> onError<span class="token operator">:</span> onError<span class="token punctuation">,</span> onLoading<span class="token operator">:</span> OnLoading<span class="token punctuation">,</span> onWrongWeight<span class="token operator">:</span> OnWrongWeight<span class="token operator">?</span><span class="token punctuation">,</span> onWrongHeight<span class="token operator">:</span> OnWrongHeight<span class="token operator">?</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token function">onLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> minHeight<span class="token operator">=</span> <span class="token number">50</span>
        <span class="token keyword keyword-val">val</span> minWeight <span class="token operator">=</span> <span class="token number">10</span>

        <span class="token keyword keyword-var">var</span> error <span class="token operator">=</span> <span class="token boolean">false</span>

        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>

        <span class="token comment">//If height is lower than minHeight call ourCallback</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>minHeight <span class="token operator">&gt;</span> request<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">{</span>
            onWrongHeight<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
                it<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">"Height should be bigger"</span><span class="token punctuation">)</span>
                error <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>minWeight <span class="token operator">&gt;</span> request<span class="token punctuation">.</span>weight<span class="token punctuation">)</span><span class="token punctuation">{</span>
            onWrongHeight<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
                it<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">"Weight should be bigger"</span><span class="token punctuation">)</span>
                error <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//All works fine</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> bmi <span class="token operator">=</span> <span class="token function">calcMBI</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> request<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
                <span class="token function">onSuccess</span><span class="token punctuation">(</span>bmi<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span>Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
            <span class="token function">onLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>



    <span class="token punctuation">}</span>


    <span class="token comment">/***************WITH SEALED CLASS***********************************/</span>

    <span class="token keyword keyword-sealed">sealed</span> <span class="token keyword keyword-class">class</span> Response<span class="token punctuation">{</span>
        <span class="token keyword keyword-class">class</span> <span class="token function">OKResult</span><span class="token punctuation">(</span><span class="token keyword keyword-val">val</span> result<span class="token operator">:</span>Double<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-class">class</span> <span class="token function">WrongWeight</span><span class="token punctuation">(</span><span class="token keyword keyword-val">val</span> error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-class">class</span> <span class="token function">WrongHeight</span><span class="token punctuation">(</span><span class="token keyword keyword-val">val</span> error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


    <span class="token comment">//Long calculating function with Sealed class</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">calculateWithSealed</span><span class="token punctuation">(</span>request<span class="token operator">:</span>Request<span class="token punctuation">,</span>onLoading<span class="token operator">:</span> OnLoading<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span>Response<span class="token punctuation">{</span>
        onLoading<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> minHeight<span class="token operator">=</span> <span class="token number">50</span>
        <span class="token keyword keyword-val">val</span> minWeight <span class="token operator">=</span> <span class="token number">10</span>

        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>minWeight <span class="token operator">&gt;</span> request<span class="token punctuation">.</span>weight<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span> Response<span class="token punctuation">.</span><span class="token function">WrongWeight</span><span class="token punctuation">(</span><span class="token string">"Weight should be bigger"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>minHeight <span class="token operator">&gt;</span> request<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token keyword keyword-return">return</span> <span class="token punctuation">(</span> Response<span class="token punctuation">.</span><span class="token function">WrongHeight</span><span class="token punctuation">(</span><span class="token string">"Height should be bigger"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>




        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter variable">${</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>

        <span class="token comment">//All works fine</span>
        onLoading<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> Response<span class="token punctuation">.</span><span class="token function">OKResult</span><span class="token punctuation">(</span><span class="token function">calcMBI</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> request<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token punctuation">}</span>




    <span class="token comment">/***************WITH CALLBACK INTERFACE***********************************/</span>

    <span class="token keyword keyword-interface">interface</span> BMIResponse<span class="token punctuation">{</span>
        <span class="token keyword keyword-fun">fun</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>result<span class="token operator">:</span>Double<span class="token punctuation">)</span>
        <span class="token keyword keyword-fun">fun</span> <span class="token function">onHeightError</span><span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span>
        <span class="token keyword keyword-fun">fun</span> <span class="token function">onWeightError</span><span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span>
        <span class="token keyword keyword-fun">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span>
        <span class="token keyword keyword-fun">fun</span> <span class="token function">onLoading</span><span class="token punctuation">(</span>loading<span class="token operator">:</span> Boolean<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-fun">fun</span> <span class="token function">calculateWithCallback</span><span class="token punctuation">(</span>request<span class="token operator">:</span> Request<span class="token punctuation">,</span> bmiResponse<span class="token operator">:</span> BMIResponse<span class="token punctuation">)</span><span class="token punctuation">{</span>
        bmiResponse<span class="token punctuation">.</span><span class="token function">onLoading</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-val">val</span> minHeight<span class="token operator">=</span> <span class="token number">50</span>
        <span class="token keyword keyword-val">val</span> minWeight <span class="token operator">=</span> <span class="token number">10</span>

        <span class="token keyword keyword-var">var</span> error <span class="token operator">=</span> <span class="token boolean">false</span>

        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>

        <span class="token comment">//If height is lower than minHeight call ourCallback</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>minHeight <span class="token operator">&gt;</span> request<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">{</span>
            bmiResponse<span class="token punctuation">.</span><span class="token function">onHeightError</span><span class="token punctuation">(</span><span class="token string">"Height should be bigger"</span><span class="token punctuation">)</span>
            error <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>minWeight <span class="token operator">&gt;</span> request<span class="token punctuation">.</span>weight<span class="token punctuation">)</span><span class="token punctuation">{</span>
            bmiResponse<span class="token punctuation">.</span><span class="token function">onWeightError</span><span class="token punctuation">(</span><span class="token string">"Weight should be bigger"</span><span class="token punctuation">)</span>
            error <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//All works fine</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">{</span>
                <span class="token keyword keyword-val">val</span> bmi <span class="token operator">=</span> <span class="token function">calcMBI</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> request<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
                bmiResponse<span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>bmi<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span>Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
                bmiResponse<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        bmiResponse<span class="token punctuation">.</span><span class="token function">onLoading</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section></section>

<p>Using callbacks we use an interface like this:
</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-interface">interface</span> BMIResponse<span class="token punctuation">{</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>result<span class="token operator">:</span>Double<span class="token punctuation">)</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onHeightError</span><span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onWeightError</span><span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onLoading</span><span class="token punctuation">(</span>loading<span class="token operator">:</span> Boolean<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br><br>

<p>Using functions we have define some <span class="r-word">typealias</span> </p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-typealias">typealias</span> OnWrongHeight <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> OnWrongWeight <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> onError <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> OnSuccess <span class="token operator">=</span> <span class="token punctuation">(</span>bmi<span class="token operator">:</span>Double<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit
<span class="token keyword keyword-typealias">typealias</span> OnLoading <span class="token operator">=</span> <span class="token punctuation">(</span>loading<span class="token operator">:</span>Boolean<span class="token punctuation">)</span><span class="token operator">-&gt;</span>Unit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br><br>

<p>Using <span class="r-word">sealed classes</span>  we have defined it</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-sealed">sealed</span> <span class="token keyword keyword-class">class</span> Response<span class="token punctuation">{</span>
    <span class="token keyword keyword-class">class</span> <span class="token function">OKResult</span><span class="token punctuation">(</span><span class="token keyword keyword-val">val</span> result<span class="token operator">:</span>Double<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-class">class</span> <span class="token function">WrongWeight</span><span class="token punctuation">(</span><span class="token keyword keyword-val">val</span> error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-class">class</span> <span class="token function">WrongHeight</span><span class="token punctuation">(</span><span class="token keyword keyword-val">val</span> error<span class="token operator">:</span>String<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">Response</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br><br>

<p>Notice that we have added some extra function in order to control (in the backend side) some errors concerning the weight and height that they have a min value in this case.
    Also look at the loading it is to indicate <span class="r-word">ViewModel</span>  when we have started and stopped </p>

<p>Now let's see how our ViewModel looks. Depending on the case, we have to pass a callback, or implementing functions, o getting the resulted sealed class.</p>

<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">BMICalculatorViewModel.kt</span>
    </section>
<section class="marco-b">
<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-package">package</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index<span class="token punctuation">.</span>viewmodel

<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>MutableLiveData
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>ViewModel
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index<span class="token punctuation">.</span>model<span class="token punctuation">.</span>BMICalculator
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index<span class="token punctuation">.</span>model<span class="token punctuation">.</span>BMICalculator<span class="token punctuation">.</span>BMIResponse
<span class="token keyword keyword-import">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword keyword-class">class</span> BMICalculatorViewModel<span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> bmiCalculator<span class="token operator">:</span> BMICalculator <span class="token operator">=</span> <span class="token function">BMICalculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword keyword-val">val</span> bmi <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>Double<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> heightError <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> weightError <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> error <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> loading <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>



    <span class="token comment">//Choose which of the three methods you want to use</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">calculateBMI</span><span class="token punctuation">(</span>weight<span class="token operator">:</span>Double<span class="token punctuation">,</span>height<span class="token operator">:</span>Double<span class="token punctuation">)</span><span class="token punctuation">{</span>
        
        <span class="token comment">//calculateBMIFunctions(weight,height)</span>
        <span class="token function">calculateBMICallBack</span><span class="token punctuation">(</span>weight<span class="token punctuation">,</span>height<span class="token punctuation">)</span>
        <span class="token comment">//calculateBMISealed(weight,height)</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**********WITH FUNCTIONS *************************/</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">calculateBMIFunctions</span><span class="token punctuation">(</span>weight<span class="token operator">:</span> Double<span class="token punctuation">,</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//Using coroutine</span>
        <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            <span class="token comment">//Using callbacks</span>
            bmiCalculator<span class="token punctuation">.</span><span class="token function">calculateWithFunctions</span><span class="token punctuation">(</span>BMICalculator<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>weight<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span>
                onSuccess <span class="token operator">=</span> <span class="token punctuation">{</span> mBMI<span class="token operator">-&gt;</span>
                    bmi<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>mBMI<span class="token punctuation">)</span>
                    heightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                    weightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                    error<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                onError <span class="token operator">=</span> <span class="token punctuation">{</span>
                        e <span class="token operator">-&gt;</span> error<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                onLoading <span class="token operator">=</span> <span class="token punctuation">{</span>
                        isLoading <span class="token operator">-&gt;</span> loading<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>isLoading<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                onWrongWeight <span class="token operator">=</span> <span class="token punctuation">{</span>
                        e <span class="token operator">-&gt;</span> weightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/******************WITH CALLBACK*************************************/</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">calculateBMICallBack</span><span class="token punctuation">(</span>weight<span class="token operator">:</span> Double<span class="token punctuation">,</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>


        <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            bmiCalculator<span class="token punctuation">.</span><span class="token function">calculateWithCallback</span><span class="token punctuation">(</span>
                BMICalculator<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>weight<span class="token punctuation">,</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword keyword-object">object</span><span class="token operator">:</span>BMIResponse<span class="token punctuation">{</span>
                    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>result<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        bmi<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                        error<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                        heightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                        weightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onHeightError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        heightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onWeightError</span><span class="token punctuation">(</span>error<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        weightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>mError<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        error<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>mError<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onLoading</span><span class="token punctuation">(</span>mLoading<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        loading<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>mLoading<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span>


        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/******************WITH SEALED***************************************/</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">calculateBMISealed</span><span class="token punctuation">(</span>weight<span class="token operator">:</span> Double<span class="token punctuation">,</span> height<span class="token operator">:</span> Double<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//viewModelScope.launch {</span>
            <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>
            loading<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            bmiCalculator<span class="token punctuation">.</span><span class="token function">calculateWithSealed</span><span class="token punctuation">(</span>BMICalculator<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>weight<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword keyword-null">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span><span class="token punctuation">{</span> res <span class="token operator">-&gt;</span>
                <span class="token keyword keyword-when">when</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword keyword-is">is</span> BMICalculator<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>OKResult <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        bmi<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
                        heightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                        weightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
                        error<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
                    <span class="token keyword keyword-is">is</span> BMICalculator<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>WrongHeight <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                        heightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword keyword-is">is</span> BMICalculator<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>WrongWeight <span class="token operator">-&gt;</span><span class="token punctuation">{</span>
                        weightError<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
            loading<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>




<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section>
</section>
<p>As you can see the process is almost the same in the three variations. Make de call to our Model, 
    then through <span class="negrita">callback</span> , <span class="negrita">function</span> , or <span class="negrita">returned sealed class</span> 
     to set the data (bmi, errors, loading) into our LiveData with postValue()</p>
    
     <p>We've added some LiveData more</p>

     <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> bmi <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>Double<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> heightError <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> weightError <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> error <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> loading <span class="token operator">:</span> MutableLiveData<span class="token operator">&lt;</span>Boolean<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>


<p>Now, we have to observe all this LiveData in our View (Fragment).</p>
<p>Notice that we've added some extra checks in our views such us height or weight are not of double type. This kind of checks are usefull doing in the view side</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
    mHeight <span class="token operator">=</span> binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e <span class="token operator">:</span> Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
    binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token string">"You should insert a number"</span>
    error <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br><br>


<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">BMIFragment.kt</span>
    </section>
<section class="marco-b">


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-package">package</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index

<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>LayoutInflater
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>ViewModelProvider
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index<span class="token punctuation">.</span>databinding<span class="token punctuation">.</span>FragmentBMIBinding
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index<span class="token punctuation">.</span>model<span class="token punctuation">.</span>BMICalculator
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>body_mass_index<span class="token punctuation">.</span>viewmodel<span class="token punctuation">.</span>BMICalculatorViewModel
<span class="token keyword keyword-import">import</span> java<span class="token punctuation">.</span>text<span class="token punctuation">.</span>DecimalFormat
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Activity
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>inputmethod<span class="token punctuation">.</span>InputMethodManager


<span class="token keyword keyword-class">class</span> BMIFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> binding<span class="token operator">:</span> FragmentBMIBinding


    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>
        inflater<span class="token operator">:</span> LayoutInflater<span class="token punctuation">,</span> container<span class="token operator">:</span> ViewGroup<span class="token operator">?</span><span class="token punctuation">,</span>
        savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> View<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token comment">// Inflate the layout for this fragment</span>
        <span class="token keyword keyword-return">return</span> FragmentBMIBinding
            <span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>inflater<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> binding <span class="token operator">=</span> it <span class="token punctuation">}</span><span class="token punctuation">.</span>root

    <span class="token punctuation">}</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>
        <span class="token comment">/*binding.btnCalculate.setOnClickListener {


            binding.progressCircular.visibility = View.VISIBLE

            val bmiCalculator = BMICalculator()
            val mHeight = binding.etHeight.text.toString().toDouble()
            val mWeight = binding.etWeight.text.toString().toDouble()

            val bmi = bmiCalculator.calculate(BMICalculator.Request(mWeight, mHeight))
            val dec = DecimalFormat("#,###.00")

            binding.tvBMI.text = dec.format(bmi).toString()
            binding.progressCircular.visibility = View.GONE
        }*/</span>

        <span class="token comment">//Obtaining a reference to our ViewModel</span>
        <span class="token keyword keyword-val">val</span> bmiCalculatorViewModel<span class="token operator">:</span>BMICalculatorViewModel <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">[</span>BMICalculatorViewModel<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">]</span>
        binding<span class="token punctuation">.</span>btnCalculate<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{</span>

            <span class="token function">closeKeyBoard</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token comment">//Closing soft keyboard</span>

            <span class="token keyword keyword-var">var</span> error <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token keyword keyword-var">var</span> mHeight <span class="token operator">=</span> <span class="token number">0.0</span>
            <span class="token keyword keyword-var">var</span> mWeight <span class="token operator">=</span> <span class="token number">0.0</span>

            binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
            binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
            <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
                mHeight <span class="token operator">=</span> binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e <span class="token operator">:</span> Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
                binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token string">"You should insert a number"</span>
                error <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>

            <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
                mWeight <span class="token operator">=</span> binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span>e <span class="token operator">:</span> Exception<span class="token punctuation">)</span><span class="token punctuation">{</span>
                binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token string">"You should insert a number"</span>
                error <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>

            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span><span class="token operator">!</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//Call to calculator viewModel</span>
                bmiCalculatorViewModel<span class="token punctuation">.</span><span class="token function">calculateBMI</span><span class="token punctuation">(</span>mWeight<span class="token punctuation">,</span>mHeight<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>


        <span class="token punctuation">}</span>

        <span class="token comment">//keep observing change on mbi from viewModel</span>
        bmiCalculatorViewModel<span class="token punctuation">.</span>bmi<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span><span class="token punctuation">{</span> newBMI <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-val">val</span> dec <span class="token operator">=</span> <span class="token function">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">"#,###.00"</span><span class="token punctuation">)</span>

            binding<span class="token punctuation">.</span>tvBMI<span class="token punctuation">.</span>text <span class="token operator">=</span> dec<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>newBMI<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
            binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>
        <span class="token punctuation">}</span>

        bmiCalculatorViewModel<span class="token punctuation">.</span>weightError<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span><span class="token punctuation">{</span> error <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">.</span>tvBMI<span class="token punctuation">.</span>text  <span class="token operator">=</span> <span class="token string">""</span>
                binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>error <span class="token operator">=</span> error
            <span class="token punctuation">}</span><span class="token keyword keyword-else">else</span>
                binding<span class="token punctuation">.</span>etWeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>

        <span class="token punctuation">}</span>
        bmiCalculatorViewModel<span class="token punctuation">.</span>heightError<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span><span class="token punctuation">{</span> error <span class="token operator">-&gt;</span>

            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">.</span>tvBMI<span class="token punctuation">.</span>text  <span class="token operator">=</span> <span class="token string">""</span>
                binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>error <span class="token operator">=</span> error
            <span class="token punctuation">}</span><span class="token keyword keyword-else">else</span>
                binding<span class="token punctuation">.</span>etHeight<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>




        <span class="token punctuation">}</span>
        bmiCalculatorViewModel<span class="token punctuation">.</span>error<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span><span class="token punctuation">{</span> error <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span>
                 binding<span class="token punctuation">.</span>tvBMI<span class="token punctuation">.</span>text <span class="token operator">=</span> error


        <span class="token punctuation">}</span>

        bmiCalculatorViewModel<span class="token punctuation">.</span>loading<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span><span class="token punctuation">{</span> isLoading <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>isLoading<span class="token punctuation">)</span>
                binding<span class="token punctuation">.</span>progressCircular<span class="token punctuation">.</span>visibility <span class="token operator">=</span>  View<span class="token punctuation">.</span>VISIBLE
            <span class="token keyword keyword-else">else</span>
                binding<span class="token punctuation">.</span>progressCircular<span class="token punctuation">.</span>visibility <span class="token operator">=</span>  View<span class="token punctuation">.</span>GONE
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">closeKeyBoard</span><span class="token punctuation">(</span>view<span class="token operator">:</span>View<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token punctuation">(</span>activity<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Activity<span class="token punctuation">.</span>INPUT_METHOD_SERVICE<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> InputMethodManager<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
                <span class="token function">hideSoftInputFromWindow</span><span class="token punctuation">(</span>view<span class="token punctuation">.</span>windowToken<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section>        
</section>

<p>Github <a class="enlace" target="_blank" href="https://github.com/sdram58/EjemplosPMDM2223/tree/master/UD6/BodyMassIndexCalculator">link</a> to the code</p>

<div class="tarea">
    <p><span class="negrita">Exercise</span> </p>
    
<p>You implement a View that performs an action on a Model. For example a Mortgage calculator. Formula: capital*interest/12/(1-Math.pow(1+(interes/12),-returnPeriod*12)) where interest can be an arbitrary value (0.01605) or even an other field </p>
<p>The View has to get data from the user, and the Model has to use it to perform the action.</p>
<p>The Model must impose some kind of restriction on the data. Term (minimun number of months), capital (Max and min capital borrowed) </p>
<p>The View should show the result of the action, and report errors and progress.</p>

</div>

    </section><!-- End section -->

    <!--*********************************************************LIVE DATA***********************************************************-->
    <section class="apartado">
    <a name="sLiveData"></a>
    <h2>LIVE DATA</h2>
    

    <p><span class="r-word">LiveData</span>  is a class to hold <span class="negrita">observable</span>  data.</p>
    
<p>It is specifically designed to be used in Activities, Fragments or Services, so that it only notifies the observers if the Activity, Fragment or Service is running.</p>

<p>Android provides <span class="r-word">LiveData</span>  and <span class="r-word">MutableLiveData</span> classes that allow you to store any type of data, 
    and observe its changes.</p>

<p>We will develop an app that consists of a <span class="d-word">Gymnastics Trainer</span>.</p>

    <figure><img src="./MVVM - Live Data - Flows_files/ud6_running.gif"><br><figcaption>Running App: Trainer</figcaption></figure>
    <br>
    
    <h3>Creating the proyect</h3>

    <ol>
        <li>Select <span class="negrita">Empty Activity</span>  template</li>
        <li>Add the following dependencies</li>

        <section class="marco-t file-">
            <span class="icono file"> </span> <span class="negrita">build.gradle (Module: app)</span>
            </section>
        <section class="marco-b">
            <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">dependencies <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    def liveDataVersion <span class="token operator">=</span><span class="token string">"2.5.1"</span>
    implementation <span class="token string">"androidx.lifecycle:lifecycle-viewmodel-ktx:<span class="token interpolation variable">$liveDataVersion</span>"</span>
    implementation <span class="token string">"androidx.lifecycle:lifecycle-livedata-ktx:<span class="token interpolation variable">$liveDataVersion</span>"</span>

    def navigationVersion <span class="token operator">=</span> <span class="token string">"2.5.3"</span>
    implementation <span class="token string">"androidx.navigation:navigation-fragment-ktx:<span class="token interpolation variable">$navigationVersion</span>"</span>
    implementation <span class="token string">"androidx.navigation:navigation-ui-ktx:<span class="token interpolation variable">$navigationVersion</span>"</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
            </section>
        </section>

        <li>Activate View Binding</li>

        <section class="marco-t file-">
            <span class="icono file"> </span> <span class="negrita">build.gradle (Module: app)</span>
            </section>
        <section class="marco-b">
                <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">android <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    buildFeatures <span class="token punctuation">{</span>
        viewBinding <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
                </section>
        </section>
        
    <li>Create Navigation Graph: <span class="inline-file">res/navigation/nav_graph.xml</span>
         <br>
         Add the <span class="r-word">NavHostFragment</span>  to the <span class="negrita">MainActivity</span> 's layout

         <section class="marco-t file-">
             <span class="icono file"> </span> <span class="negrita">res/layout/activity_main.xml</span>
             </section>
         <section class="marco-b">
                 <section><div class="code-toolbar"><pre class="language-xml line-numbers" tabindex="0"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.constraintlayout.widget.ConstraintLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>app</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res-auto<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>androidx.fragment.app.FragmentContainerView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>androidx.navigation.fragment.NavHostFragment<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/nav_host_fragment<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>defaultNavHost</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">app:</span>navGraph</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@navigation/nav_graph<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>androidx.constraintlayout.widget.ConstraintLayout</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
                 </section>
         </section>
         
    </li>

    <li>Add a destination in the <span class="inline-file">nav_graph.xml</span> called <span class="d-word">TrainerFragment</span>
    <br>
    Configure the <span class="negrita">ViewBinding</span>
        <section class="marco-t file-">
            <span class="icono file"> </span> <span class="negrita">TrainerFragment.kt</span>
            </section>
        <section class="marco-b">
             <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>LayoutInflater
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer<span class="token punctuation">.</span>databinding<span class="token punctuation">.</span>FragmentTrainerBinding


<span class="token keyword keyword-class">class</span> TrainerFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> binding<span class="token operator">:</span>FragmentTrainerBinding

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>
        inflater<span class="token operator">:</span> LayoutInflater<span class="token punctuation">,</span> container<span class="token operator">:</span> ViewGroup<span class="token operator">?</span><span class="token punctuation">,</span>
        savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> View<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token comment">// Inflate the layout for this fragment</span>
        <span class="token keyword keyword-return">return</span> FragmentTrainerBinding<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>inflater<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> binding <span class="token operator">=</span> it <span class="token punctuation">}</span>
            <span class="token punctuation">.</span>root
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
             </section>
        </section>
        
</li>

<li>
    Add the following Views to the Layout:
    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita">res/layout/fragment_trainer.xml</span>
        </section>
    <section class="marco-b">
        <section><div class="code-toolbar"><pre class="language-xml line-numbers" tabindex="0"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FrameLayout</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">xmlns:</span>tools</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/tools<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">tools:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>TrainerFragment<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ImageView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/ivExercise<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/tvRepetition<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>wrap_content<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>48sp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TextView</span>
        <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/tvChange<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>background</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#ddee44<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textColor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@color/white<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>visibility</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>gone<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>text</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Change<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>gravity</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>center<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>textSize</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>48sp<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FrameLayout</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section>
    </section>
    
</li>

<li>Download the gif images from 
    <a class="enlace" target="_blank" href="https://github.com/sdram58/EjemplosPMDM2223/blob/master/UD6/GymnasticsTrainer/app/src/main/res/raw/images.zip">here</a>
and drag them to the <span class="inline-folder">res/drawable</span> folder </li>
        
    </ol>


    <h3>Trainer</h3>

    <p>The following class implements the <span class="d-word">Trainer</span>. Its function is to give orders, which consist of what exercise to do and the number of repetitions. 
        When the repetition number reaches 0, it warns of the change and changes the exercise.</p>

    
    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita">Trainer.kt</span>
        </section>
    <section class="marco-b">
            <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-package">package</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer<span class="token punctuation">.</span>model

<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>LiveData
<span class="token keyword keyword-import">import</span> kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span>

<span class="token keyword keyword-import">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>MutableLiveData




<span class="token keyword keyword-typealias">typealias</span>  OnOrder <span class="token operator">=</span> <span class="token punctuation">(</span>order<span class="token operator">:</span>String<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit

<span class="token keyword keyword-class">class</span> Trainer <span class="token punctuation">{</span>
    <span class="token keyword keyword-val">val</span> random<span class="token operator">:</span>Random <span class="token operator">=</span> <span class="token function">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-var">var</span> training<span class="token operator">:</span>Job<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword keyword-null">null</span>

    <span class="token keyword keyword-var">var</span> exercise <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword keyword-var">var</span> repetitions <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>


    <span class="token keyword keyword-fun">fun</span> <span class="token function">startTraining</span><span class="token punctuation">(</span>onOrder<span class="token operator">:</span> OnOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>training <span class="token operator">==</span> <span class="token keyword keyword-null">null</span> <span class="token operator">||</span> training<span class="token operator">!!</span><span class="token punctuation">.</span>isCancelled <span class="token operator">||</span> training<span class="token operator">!!</span><span class="token punctuation">.</span>isCompleted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            training <span class="token operator">=</span> <span class="token function">CoroutineScope</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">launch</span> <span class="token punctuation">{</span>

                <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>repetitions <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        repetitions <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span>
                        exercise <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">onOrder</span><span class="token punctuation">(</span><span class="token string">"EXERCISE"</span> <span class="token operator">+</span> exercise <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>repetitions <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token string">"CHANGE"</span> <span class="token keyword keyword-else">else</span> repetitions<span class="token punctuation">)</span>
                    repetitions<span class="token operator">--</span>

                    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-fun">fun</span> <span class="token function">stopTraining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        training<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>isActive<span class="token punctuation">)</span>
                it<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        exercise <span class="token operator">=</span> <span class="token number">0</span>
        repetitions <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
            </section>

            <p>If it all works fine and in an console enviroment we could get an exit like this:</p>

            <section><div class="code-toolbar"><pre class="language-xml line-numbers" tabindex="0"><code class="language-xml">Start
EXERCISE2:3
EXERCISE2:2
EXERCISE2:1
EXERCISE2:CHANGE
EXERCISE1:3
EXERCISE1:2
EXERCISE1:1
EXERCISE1:CHANGE
EXERCISE4:3
EXERCISE4:2
EXERCISE4:1
EXERCISE4:CHANGE
EXERCISE3:6
EXERCISE3:5
EXERCISE3:4
stop
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
            </section><br><br>
            
    </section>

    <section class="marco-t warn">
        <span class="icono warning"> </span>Please, Note that our app still shows <span class="negrita">nothing</span> 
        </section>
    <section class="marco-b">
            
    </section>
    
    

    <h3>LiveData</h3>

    <p>There are two ways to use <span class="r-word">LiveData</span> : instantiating the <span class="r-word">MutableLiveData</span>  class 
        or extending the <span class="r-word">LiveData</span>  class.</p>
    
    <p class="sub-section">MutableLiveData</p>
    
    <p>To instantiate a <span class="r-word">MutableLiveData</span>  class object, you must put the type of data it is going to store in the diamond &lt;&gt;. 
        For example to create a <span class="r-word">MutableLiveData</span> of type <span class="r-word">Integer</span>:</p>

        <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> integerNumberLiveData <span class="token operator">=</span> MutableLiveData<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section><br><br>  

    <p>In the construtor, you can pass the initial value as argument:</p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> integerNumberLiveData <span class="token operator">=</span> <span class="token function">MutableLiveData</span><span class="token punctuation">(</span><span class="token number">2400</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>

    <p>To change the value that a <span class="r-word">MutableLiveData</span> contains, two methods are provided:</p>

    <ul>
        <li><span class="r-word">setValue()</span>: allows you to change the value <span class="negrita">from the main thread</span> </li>
        <li><span class="r-word">postValue()</span>: allows changing the value <span class="negrita">from a background thread</span> </li>
</ul>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">integerNumberLiveData<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// it can only be done from Main Thread</span>
integerNumberLiveData<span class="token punctuation">.</span><span class="token function">postValue</span><span class="token punctuation">(</span><span class="token number">7802</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br><br>

<p>Both methods cause observers to be notified of the value change.</p>

<p>To observe a <span class="r-word">LiveData</span>  or <span class="r-word">MutableLiveData</span>  object, the <span class="r-word">observe()</span> 
     method must be called. This method must be passed the <span class="negrita">Activity</span>  or the <span class="negrita">Fragment</span> 
      from which it is observed, and the <span class="d-word">Observer</span> callback which will be called to notify the value changes. 
      Notifications of value changes will only be made if the Activity or the Fragment is running.</p>

<p>To get the Fragment or Activity and pass it to the <span class="r-word">observe()</span>  method, you can use the <span class="r-word">viewLifecycleOwner</span>  getter method.</p>

<p>The following code illustrates how to begin observing a <span class="r-word">LiveData</span>  object:</p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">integerNumberLiveData<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">,</span> <span class="token keyword keyword-object">object</span> <span class="token operator">:</span> <span class="token function">Observer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-fun">fun</span> <span class="token function">onChanged</span><span class="token punctuation">(</span><span class="token annotation builtin">@Nullable</span> value<span class="token operator">:</span> Int<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// update UI with the new value</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>

    or even better or more readable version

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">integerNumberLiveData<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span> <span class="token punctuation">{</span> value <span class="token operator">-&gt;</span>
    <span class="token comment">// update UI with the new value</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>
    
<p class="sub-section">LiveData</p>

<p>In the case of a <span class="r-word">MutableLiveData</span> object, it is an external entity that calls the <span class="r-word">setValue()</span> 
     or <span class="r-word">postValue()</span>  methods to change the value.</p>

<p>It is possible to extend the <span class="r-word">LiveData</span> class to make the object itself change its value. 
    When the <span class="r-word">LiveData</span>  class is extended there are two methods that need to be overridden:</p>

    <ol>
        <li><span class="r-word">onActive()</span>: This method is executed when you have an active observer.</li>
        <li><span class="r-word">onInactive()</span>: This method is executed when you no longer have any active observers.</li>
    </ol>

    <p>The <span class="r-word">setValue()</span>  method updates the value and notifies the active observers.</p>


    <p class="sub-section">Conclusion</p>

    <p>To change the value of a <span class="r-word">MutableLiveData</span> , you have to call the <span class="r-word">setValue()</span> 
         or <span class="r-word">postValue()</span>  method, from an external entity.</p>
    
    <p>To change the value of a <span class="r-word">LiveData</span> , <span class="r-word">LiveData</span>  itself calls the <span class="r-word">setValue()</span>  or <span class="r-word">postValue()</span> 
         method.</p>
    
    <figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-07-20-43-34.png"><br><figcaption></figcaption></figure>
    <br>
    

    <h3>Implemention LiveData</h3>
    
    <p>In the case of the <span class="d-word">Trainer</span>  class, it is very useful to extend the <span class="r-word">LiveData</span>  class. 
            Since in this way it will be the <span class="d-word">Trainer</span>  himself who will change his exercise on his own without anyone having to tell him.</p>
        
    
<p>It is important to understand that the <span class="d-word">trainer</span>  should only be sending exercises if there is an active observer, that is, if the fragment is running.</p>
            
<p>The <span class="r-word">LiveData</span>  implementation would look like this:</p>


<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">Trainer.kt</span>
    </section>
<section class="marco-b">
     <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span> 
<span class="token keyword keyword-val">val</span> orderLiveData<span class="token operator">:</span>LiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword keyword-object">object</span><span class="token operator">:</span>LiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        startTraining <span class="token punctuation">{</span> 
            order <span class="token operator">-&gt;</span> <span class="token function">postValue</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onInactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onInactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">stopTraining</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
     </section>  
</section>

<p>Now,  when there is an observer for the variable <span class="d-word">orderLiveData</span> , the <span class="r-word">onActive()</span>  method will be called and 
    the trainer will begin training and will change the value of the <span class="d-word">order</span> , notifying the observers of the new <span class="negrita">order</span> .</p>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-07-21-12-43.png"><br><figcaption></figcaption></figure>
<br>

<p>When there is no observer (that is, when the fragment is closed), the trainer will stop training.</p>


<h3>Transformations</h3>

<p>At this point we already have the variable <span class="d-word">orderLiveData</span>  that is emitting the exercise orders.</p>

<p>It might seem that from the View we can already observe this variable and use its value to show the user the image of the corresponding exercise, thus dispensing with the <span class="r-word">ViewModel</span>.
     However, the <span class="r-word">ViewModel</span>  fulfills another function, which is to <span class="negrita">transform</span>  the data from Model into the data that the view needs.</p>

<p>In this case, the model (the trainer) sends the orders in <span class="negrita">String</span> format, separating the exercise to be done and the repetition with a colon 
    <span class="d-word">(EXERCISE: 5)</span> . The View, for its part, needs to know separately which <span class="subrayado">image to display and the repetition number</span> . 
    It will then be the <span class="r-word">ViewModel</span>  that will transform the String emitted by <span class="r-word">LiveData</span> 
    order into the two different data that the View needs.</p>

<p>Two transformations must be made:</p>

<ul>
    <li>In one, the <span class="d-word">orderLiveData</span>  will be observed and it will be transformed into another LiveData <span class="d-word">exerciseLiveData</span>
     that only contains the image to be displayed, and that only changes, when the exercise changes (not the repetition).</li>
     <li>In the other, <span class="d-word">orderLiveData</span>  will be observed and it will be transformed into the LiveData <span class="d-word">repetitionLiveData</span>  that contains the repetition.</li>
</ul>
<br>

<figure><img src="./MVVM - Live Data - Flows_files/ud6-2021-11-07-21-30-07.png"><br><figcaption></figcaption></figure>
<br>

<p>To transform one <span class="r-word">LiveData</span>  into another, Android provides the <span class="negrita">Transformations</span> class. 
    This class has the <span class="r-word">switchMap()</span>  method that allows observing a <span class="r-word">LiveData</span>  and returning a different <span class="r-word">LiveData</span>.</p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">transformedLiveData <span class="token operator">:</span> LiveData <span class="token operator">=</span> Transformations<span class="token punctuation">.</span><span class="token function">switchMap</span><span class="token punctuation">(</span>originalLiveData<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//Transformation method</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>

<p>The implementation of the <span class="d-word">TrainerViewModel</span>  looks like this:</p>

<section class="marco-t file-">
    <span class="icono file"> </span> <span class="negrita">TrainerViewModel.kt</span>
    </section>
<section class="marco-b">
        <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-package">package</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer<span class="token punctuation">.</span>viewmodel

<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Application
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>AndroidViewModel
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>LiveData
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>Transformations
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Trainer
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>MutableLiveData
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer<span class="token punctuation">.</span>R


<span class="token keyword keyword-class">class</span> <span class="token function">TrainerViewModel</span><span class="token punctuation">(</span>application<span class="token operator">:</span> Application<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">AndroidViewModel</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> trainer<span class="token operator">:</span> Trainer <span class="token operator">=</span> <span class="token function">Trainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword keyword-var">var</span> exerciseLiveData <span class="token operator">:</span>LiveData<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span>
    <span class="token keyword keyword-var">var</span> repetitionLiveData <span class="token operator">:</span>LiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-var">var</span> previousExercise<span class="token operator">:</span>String <span class="token operator">=</span><span class="token string">""</span>


    <span class="token keyword keyword-init">init</span> <span class="token punctuation">{</span>

        exerciseLiveData <span class="token operator">=</span> Transformations<span class="token punctuation">.</span><span class="token function">switchMap</span><span class="token punctuation">(</span>trainer<span class="token punctuation">.</span>orderLiveData<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                exercise <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-val">val</span> mExercise <span class="token operator">=</span> exercise<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>mExercise <span class="token operator">!=</span> previousExercise<span class="token punctuation">)</span><span class="token punctuation">{</span>
                previousExercise <span class="token operator">=</span> mExercise

                <span class="token keyword keyword-var">var</span> imageID<span class="token operator">:</span>Int <span class="token operator">=</span> <span class="token keyword keyword-when">when</span><span class="token punctuation">(</span>mExercise<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token string">"EXERCISE1"</span> <span class="token operator">-&gt;</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>e1
                    <span class="token string">"EXERCISE2"</span> <span class="token operator">-&gt;</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>e2
                    <span class="token string">"EXERCISE3"</span> <span class="token operator">-&gt;</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>e3
                    <span class="token string">"EXERCISE4"</span> <span class="token operator">-&gt;</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>e4
                    <span class="token keyword keyword-else">else</span> <span class="token operator">-&gt;</span> R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>e1

                <span class="token punctuation">}</span>
                <span class="token keyword keyword-return">return</span><span class="token label symbol">@switchMap</span> MutableLiveData<span class="token operator">&lt;</span>Int<span class="token operator">&gt;</span><span class="token punctuation">(</span>imageID<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token keyword keyword-return">return</span><span class="token label symbol">@switchMap</span> <span class="token keyword keyword-null">null</span>
        <span class="token punctuation">}</span>

        repetitionLiveData <span class="token operator">=</span> Transformations<span class="token punctuation">.</span><span class="token function">switchMap</span><span class="token punctuation">(</span>trainer<span class="token punctuation">.</span>orderLiveData<span class="token punctuation">)</span> <span class="token punctuation">{</span> exercise <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-return">return</span><span class="token label symbol">@switchMap</span> MutableLiveData<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span>exercise<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>



    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section><br><br>
</section>


<p>To transform the <span class="negrita">order</span>  into the <span class="negrita">exercise</span> , we save the previous exercise, so that we only return a new <span class="r-word">LiveData</span>  with the corresponding image 
    if the exercise has changed with respect to the previous order. If it is the same exercise as the previous one, we return <span class="cursiva"><span class="negrita">null</span></span> 
    , and in that case <span class="subrayado">the transformation is not applied, and the observer is not notified</span>.</p>

<p>To transform the <span class="negrita">order</span>  into <span class="negrita">repetition</span> , you just have to stick with what is after the colon. 
    In this case, the previous order must not be taken into account, since the repetition always changes.</p>


    <h3>Updating the View</h3>

    <p>The last step is only for the view to observe the <span class="cursiva">exercise</span>  and the <span class="cursiva">repetition</span> and to show them to the user.</p>
    

    <p>The implementation of the view looks like this:</p>
    
    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita">TrainerFragment.kt</span>
        </section>
    <section class="marco-b">
           <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-package">package</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer

<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Bundle
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>fragment<span class="token punctuation">.</span>app<span class="token punctuation">.</span>Fragment
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>LayoutInflater
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>View
<span class="token keyword keyword-import">import</span> android<span class="token punctuation">.</span>view<span class="token punctuation">.</span>ViewGroup
<span class="token keyword keyword-import">import</span> androidx<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span>ViewModelProvider
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer<span class="token punctuation">.</span>databinding<span class="token punctuation">.</span>FragmentTrainerBinding
<span class="token keyword keyword-import">import</span> com<span class="token punctuation">.</span>cartatar<span class="token punctuation">.</span>livedatatrainer<span class="token punctuation">.</span>viewmodel<span class="token punctuation">.</span>TrainerViewModel


<span class="token keyword keyword-class">class</span> TrainerFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-lateinit">lateinit</span> <span class="token keyword keyword-var">var</span> binding<span class="token operator">:</span>FragmentTrainerBinding

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onCreateView</span><span class="token punctuation">(</span>
        inflater<span class="token operator">:</span> LayoutInflater<span class="token punctuation">,</span> container<span class="token operator">:</span> ViewGroup<span class="token operator">?</span><span class="token punctuation">,</span>
        savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> View<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token comment">// Inflate the layout for this fragment</span>
        <span class="token keyword keyword-return">return</span> FragmentTrainerBinding<span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>inflater<span class="token punctuation">,</span> container<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> binding <span class="token operator">=</span> it <span class="token punctuation">}</span>
            <span class="token punctuation">.</span>root
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-override">override</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-super">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>

        <span class="token keyword keyword-val">val</span> trainerViewModel <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span><span class="token keyword keyword-this">this</span><span class="token punctuation">)</span><span class="token punctuation">[</span>TrainerViewModel<span class="token operator">::</span><span class="token keyword keyword-class">class</span><span class="token punctuation">.</span>java<span class="token punctuation">]</span>

        trainerViewModel<span class="token punctuation">.</span>exerciseLiveData<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span><span class="token punctuation">{</span> imageID <span class="token operator">-&gt;</span>
            binding<span class="token punctuation">.</span>ivExercise<span class="token punctuation">.</span><span class="token function">setImageResource</span><span class="token punctuation">(</span>imageID<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        trainerViewModel<span class="token punctuation">.</span>repetitionLiveData<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">)</span> <span class="token punctuation">{</span> repetition <span class="token operator">-&gt;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>repetition<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"CHANGE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">.</span>tvChange<span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>VISIBLE
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">.</span>tvChange<span class="token punctuation">.</span>visibility <span class="token operator">=</span> View<span class="token punctuation">.</span>GONE
            <span class="token punctuation">}</span>
            binding<span class="token punctuation">.</span>tvRepetition<span class="token punctuation">.</span>text <span class="token operator">=</span> repetition
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>


<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
           </section>
    </section>
    
    <p>If we run the app it works changing all values and images but... One moment! we download a GIF image but there is no movement in the images. It's due to Android
        doesn't support natively Gif images.
    </p>
    <p>We have some solutions such us using some librearies like Glide or Picasso but we will see them in the next chapter. Now we're using this
        <a class="enlace" target="_blank" href="https://github.com/koral--/android-gif-drawable">dependencies</a>. So let's add it on our <span class="inline-file">gradle module app</span></p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">dependencies <span class="token punctuation">{</span>

    <span class="token operator">..</span><span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span>
    implementation <span class="token string">'pl.droidsonroids.gif:android-gif-drawable:1.2.25'</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>

    <p>Now we have to make a little change on <span class="inline-file">fragment_trainer.xml</span>. We should replace <span class="r-word">ImageView</span> 
        for <span class="r-word">pl.droidsonroids.gif.GifImageView</span> </p>

    <section class="marco-t file-">
        <span class="icono file"> </span> <span class="negrita">fragment_trainer.xml</span>
        </section>
    <section class="marco-b">
    <section><div class="code-toolbar"><pre class="language-xml line-numbers" tabindex="0"><code class="language-xml">
......
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pl.droidsonroids.gif.GifImageView</span>
    <span class="token attr-name"><span class="token namespace">android:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@+id/ivExercise<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>layout_height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>match_parent<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>

......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section>
    </section>
    
    <p><a class="enlace" target="_blank" href="https://github.com/sdram58/EjemplosPMDM2223/tree/master/UD6/GymnasticsTrainer">Here</a> you have the whole code </p>


    <a name="PR4" class="tarea" target="_blank" href="https://sdram58.github.io/apuntesPMDM/unidades2223/ud6_mvvm.html#PR4">
        <p>PRACTICE</p>
        <p>You have to implement a <span class="negrita">Model</span>  with a <span class="negrita">LiveData</span> variable that emits data when it is observed.</p>
        <p>Implement a <span class="negrita">ViewModel</span>  that transforms the <span class="negrita">Model</span>  data into another <span class="negrita">LiveData</span> .</p>
        <p>Implement a <span class="negrita">View</span>  that observes the <span class="negrita">LiveData</span>  of the <span class="negrita">ViewModel</span>  and shows it to the user with images.</p>
        <p>For instance:</p>
        <ol>
            <li>The LiveData of the model can emit a String every second that says: "sun", "clouds", "rain", "wind"</li>
            <li>The ViewModel can transform that String into an image identifier like R.drawable.sun, etc.</li>
            <li>The View shows the corresponding image.</li>
        </ol>
    </a> 


    </section><!-- End section -->

    <!--*********************************************************FLOWS***********************************************************-->
    <section class="apartado">
        <a name="sFlows"></a>
        <h2>INTRODUCTION TO FLOWS</h2>
    
        <h3>Introduction</h3>

        <p>Flow is a component of the coroutine library that allows us to implement reactive programming. </p>


        <p>It is the natural substitute for RxJava, since the vast majority of things that can be done are here, generally simpler, 
            since they are based on concepts that we already know about <span class="d-word">coroutines</span> , <span class="d-word">sequences</span> , 
            and <span class="d-word">collections</span>  to give us a very easy solution.</p>
        
        <h3>What are the Flows?</h3>

        <p>Flows are asynchronous sequences.</p>
        
        <p class="sub-section">The Flows are lazy</p>
        
        <p>Like sequences, Flows are lazy, which means that until someone requests the Flow's values, the operations on them are not executed. </p>
        <p>This causes them to be called <span class="negrita">cold streams</span>, because they will not start providing data until someone asks to collect them. 
            Also, if another element connects to the Flow, it starts from the first value of the flow.</p>
        <p>It is important to understand this, because <span class="negrita">if a Flow performs heavy operations, 
            they will be repeated every time someone collects its values</span>.</p>

        
        
        <p class="sub-section">Flows are asynchronous</p>
        
        <p>Unlike sequences, which are processed one element after another, in Flow this is not necessarily the case. It can take a long time between one value and the next.</p>

        <p>That's why we won't normally run them on the main thread.</p>

        <p>Since all this happens in a coroutine context, think that the thread management is going to be very easy to manage.</p>


        <p class="sub-section">Flows are sequential</p>
        
        <p>This means that if a Flow is going to generate x elements, and these consist of heavy processing, they will be executed one after the other: 
            until the previous one finishes, the next one will not start.</p>
        
        <p>This, which is often an advantage, can sometimes be a disadvantage. 
            Imagine that you have to make 10 requests to servers and that each one is independent of the previous one. Even so, 
            you would have to wait for the previous one to finish to launch the next one.</p>

        <p>This can be modified, and we'll see later. But keep in mind that they work like this by default</p>
            
        

        <h3>Flow Builders</h3>

        <p>We have 3 ways to build a Flow:</p>
        
        <p class="sub-section">asFlow()</p>
        
        <p>Perhaps this is the easiest way to generate a Flow. All collections, including sequences, can be converted to a Flow using this function</p>
        
        <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> flow <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section><br><br>
        
        <p class="sub-section">flowOf()</p>
        
        <p>A Flow is generated with a sequence of predefined values, the equivalent of <span class="d-word">listOf()</span> 
            or <span class="d-word">sequenceOf()</span> </p>

            <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> flow <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
            </section><br><br>

        <p class="sub-section">flow { }</p>
        
        <p>The most versatile of all, and the one you will surely use most often. </p>
        <p>We create a <span class="negrita">flow { }</span>  block and add values with the <span class="negrita">emit()</span> function.</p>

        <p>Also, here we add the advantage that this block receives a coroutine context, so we can call suspend functions without any problem within it.</p>
        
        <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">flow <span class="token punctuation">{</span>
    <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>i <span class="token keyword keyword-in">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section><br><br>

    <h3>Types of operators</h3>

    <p>Flows can be transformed just like collections, making them very easy to use.</p>

    <p>We can filter, map, combine, transform... and a large number of operations that allow you to adapt these flows to the needs you have in the place where you use them.</p>
    
    <p>As with sequences, there are two types of operators</p>
    
     <p class="sub-section">Intermediate operators</p>
     
     <p>They are operators that do not launch any operation, regardless of their complexity. What they do is return a <span class="negrita">new Flow</span> that is
         the combination of the previous one with the new operation.</p>

    
    <p>For example, we can use the <span class="negrita"><span class="r-word">filter()</span> </span> operation:</p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">makeFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> flow<span class="token punctuation">{</span>
    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token function">emit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
    
<span class="token function">makeFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//user function that returns a flow</span>
    <span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> it <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">}</span>  <span class="token comment">//Only emit the even elements of the flow</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>
     
    <p>And then do a <span class="negrita"><span class="r-word">map()</span> </span>  to transform the results:</p>
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">makeFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span> <span class="token punctuation">{</span> it <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">{</span> <span class="token string">"Value is <span class="token interpolation variable">$it</span>"</span> <span class="token punctuation">}</span> <span class="token comment">//Emits the even elements and map them to a String</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>


    <p>But there is a particularly interesting operator, which is <span class="negrita"><span class="r-word">transform()</span></span> , and which allows us to make as complex transformations 
        as we need. All we have to do is call <span class="negrita">emit()</span>  with the values we want to return:</p>

        <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-if">if</span><span class="token punctuation">(</span>it <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"Value -&gt; <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section>

    <p>Output:</p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">Value <span class="token operator">-&gt;</span> <span class="token number">2</span>
Value <span class="token operator">-&gt;</span> <span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>



    <p>You can also combine multiple Flows with operations like <span class="negrita"><span class="r-word">zip()</span> </span>  or <span class="negrita"><span class="r-word">combine()</span> </span> :</p>
    
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> flow1 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> flow2 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">)</span>
flow1<span class="token punctuation">.</span><span class="token function">zip</span><span class="token punctuation">(</span>flow2<span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> b <span class="token operator">-&gt;</span> <span class="token string">"<span class="token interpolation variable">$a</span> -&gt; <span class="token interpolation variable">$b</span>"</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>


    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> flow1 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> flow2 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">)</span>
flow1<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>flow2<span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> b <span class="token operator">-&gt;</span> <span class="token string">"<span class="token interpolation variable">$a</span> -&gt; <span class="token interpolation variable">$b</span>"</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section>

    <p>Result</p>
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token number">1</span> <span class="token operator">-&gt;</span> <span class="token number">1</span>
<span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token number">2</span>
<span class="token number">3</span> <span class="token operator">-&gt;</span> <span class="token number">3</span>
<span class="token number">4</span> <span class="token operator">-&gt;</span> <span class="token number">4</span>
<span class="token number">4</span> <span class="token operator">-&gt;</span> <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>


    <p>We can apply some action to each of the flow elements with <span class="negrita"><span class="r-word">onEach()</span> </span></p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> f1 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword keyword-val">val</span> f2 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">{</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

f1<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token punctuation">{</span>f1<span class="token punctuation">,</span> f2 <span class="token operator">-&gt;</span>
    <span class="token string">"<span class="token interpolation variable">$f1</span> -&gt; <span class="token interpolation variable">$f2</span>"</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation variable">$it</span>"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section>

    <p>Result</p>
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token number">1</span> <span class="token operator">-&gt;</span> a
<span class="token number">2</span> <span class="token operator">-&gt;</span> a
<span class="token number">3</span> <span class="token operator">-&gt;</span> a
<span class="token number">3</span> <span class="token operator">-&gt;</span> b
<span class="token number">4</span> <span class="token operator">-&gt;</span> b
<span class="token number">4</span> <span class="token operator">-&gt;</span> c
<span class="token number">5</span> <span class="token operator">-&gt;</span> c
<span class="token number">5</span> <span class="token operator">-&gt;</span> d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>
    
    

    <p>Remember that all of these operators can have suspend functions inside them, 
        so those operations can be as simple as addition or as complex as calling a server and saving the result to a database.</p>
    

    <p class="sub-section">Terminal operators</p>
    
    <p>These do launch the execution and cause the production of values begins and these to be emitted.</p>

    <p>The most common terminal operator is <span class="negrita"><span class="r-word">collect()</span> </span> , 
        which tells Flow that there is already someone on the other side (the collector) waiting for results, and that it can start emitting them.</p>
    
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> flow<span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span>
    
flow<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
        </section><br><br>

    <p>Another interesting terminal function is <span class="negrita"><span class="r-word">toList()</span></span> . It will wait for the entire flow to finish emitting and turn it into a list.</p>
    <p>In this example we are going to take a previous flow and convert it into a list and print its result.</p>
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> flow1 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> flow2 <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token string">"5"</span><span class="token punctuation">)</span>

<span class="token function">println</span><span class="token punctuation">(</span>
    flow1<span class="token punctuation">.</span><span class="token function">combine</span><span class="token punctuation">(</span>flow2<span class="token punctuation">)</span> <span class="token punctuation">{</span> a<span class="token punctuation">,</span> b <span class="token operator">-&gt;</span> <span class="token string">"<span class="token interpolation variable">$a</span> -&gt; <span class="token interpolation variable">$b</span>"</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section>
    <p>Output:</p>
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">-&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">-&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">-&gt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">-&gt;</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">-&gt;</span> <span class="token number">5</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>
    

    <p>But there is not only this one, we have several more like <span class="negrita">toSet(), first(), single(), reduce()</span>  or <span class="negrita">fold()</span> .</p>
    
    <h3>Constraints on contexts and exceptions</h3>
    <p>Flow has some restrictions, to make the whole system work properly.</p>
    
    <p>The first is that we cannot switch context within the code of a flow. If we do this, we'll get an exception:</p>
    
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">makeFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> flow <span class="token punctuation">{</span>
    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-for">for</span> <span class="token punctuation">(</span>i <span class="token keyword keyword-in">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
            <span class="token function">emit</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>

<p>Flow will always run in the context of the coroutine that launched it. 
    But many times it won't be what we want, how do we then change the execution context? We can use the <span class="negrita">flowOn()</span> function:</p>

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-val">val</span> flow <span class="token operator">=</span> <span class="token function">flowOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>

flow<span class="token punctuation">.</span><span class="token function">flowOn</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>

    <p>With respect to exceptions, it happens a bit the same. Exceptions should not be caught within the flows, 
        so as not to hide them and the rest of the code does not find out. There is a special function for this:</p>
    

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">makeFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">{</span> throwable <span class="token operator">-&gt;</span> <span class="token function">println</span><span class="token punctuation">(</span>throwable<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>

<p>If we don't catch the exception, it will continue to propagate normally, as it happens with the rest of the coroutine components.</p>

<br><br>
    <h3>Types or specializations of FLows</h3>

    <p>So far we have seen the general behavior of the flows and the main characteristics. 
        Now we will see some types of flow specialization that can be interesting for certain cases.</p>
    
    <p class="sub-section">StateFlow</p>
    
    <p>Remember that we said that generic flows were <span class="cursiva">cold streams</span> , that is, until someone starts collecting their values, 
        the flow doesn't start emitting.</p>
    
    <p>The <span class="d-word">StateFlows</span>  are <span class="cursiva">hot streams</span> , that is, whether there is someone listening or not, they are going to emit values.
    If we connect to a <span class="d-word">Stateflow</span> , it will give us the last value, it will not start with the first one.</p>
    

    <p><span class="d-word">StateFlows</span>  are especially interesting for saving the state of the UI, when we connect to it, it will tell us what the last state the UI should be in is.
        From there if the state changes, the UI will receive the new state. <br>
        As you have seen, this would be the equivalent of <span class="d-word">LiveData</span> .
    </p>

    <p>Let's do an example in which we simulate a use case in which the UI is going to be updated (in this case the console), we will update the UI every second by passing it a new <span class="negrita">note</span> .
    For this, we will use a <span class="r-word">MutableStateFlow</span>  that will be of the <span class="negrita">note</span>  type.</p>
    
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">Note</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> title<span class="token operator">:</span>String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> description<span class="token operator">:</span>String
<span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//It would simulate a ViewModel but for this example is a simple class</span>

    <span class="token keyword keyword-var">var</span> state<span class="token operator">:</span> MutableStateFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span><span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Title 1"</span><span class="token punctuation">,</span> <span class="token string">"Description 1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> counter <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            state<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Title <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">,</span> <span class="token string">"Description <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">)</span>
            counter<span class="token operator">++</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//This main function is just for running the example</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Unit <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

    <span class="token keyword keyword-val">val</span> viewModel <span class="token operator">=</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    launch <span class="token punctuation">{</span>
        viewModel<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br><br>
    
    <p>Note that to update the value of the <span class="d-word">StateFlow</span> , the new value is passed through the <span class="r-word">value</span>  property of the <span class="d-word">status</span> variable. 
        Notice that to start the value of the StateFlow we pass a note in the constructor.</p>
    

    <section class="marco-t inf">
        <span class="icono info"> </span> Since the <span class="negrita">println</span>  function receives the same arguments that the <span class="negrita">lambda</span> passes, 
        we can abbreviate it using the function reference (::)
        </section>
    <section class="marco-b">
            <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token operator">::</span>println<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
            </section>
    </section>
        
    <p>The code above has a problem and that is that from the UI we could change the value of the state flow by doing this.</p>
    
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Fake title"</span><span class="token punctuation">,</span> <span class="token string">"Fake description"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>

    <p>That is, it is poorly encapsulated. To avoid that we must make the property that is accessed from outside read-only. Let's see how we could do it.</p>
    
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state<span class="token operator">:</span> MutableStateFlow <span class="token operator">=</span> <span class="token function">MutableStateFlow</span><span class="token punctuation">(</span><span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Title 1"</span><span class="token punctuation">,</span> <span class="token string">"Description 1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> state<span class="token operator">:</span>StateFlow <span class="token operator">=</span> _state<span class="token punctuation">.</span><span class="token function">asStateFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>

    <p>We see that our MutableStateFlow variable is private and offer a public one that cannot be changed, nor can the value property be modified.
        This is called <span class="cursiva">backing property</span>  </p>

    
    <a class="tarea" name="exercise_flow" target="_blank" href="https://sdram58.github.io/apuntesPMDM/unidades2223/ud6_mvvm.html#exercise_flow">Exercise:
    You modify the BMICalculator application to use StateFlow instead of LiveData.</a> 
        <br> <br>
    <p><a class="enlace" target="_blank" href="https://github.com/sdram58/ExamplesPMDM2223/tree/master/UD6/BodyMassIndexCalculatorFlow">A possible solution</a> </p>
    

    <p class="sub-section">SharedFlow</p>


    <p><span class="r-word">StateFlow</span>  is a specialization of <span class="r-word">SharedFlow</span>. <span class="r-word">SharedFlow</span> is much more configurable.
    When the exact conditions of a StateFlow are not enough for us, we can configure the <span class="r-word">SharedFlow</span>  to behave exactly as we need.</p>
    

    <p><span class="r-word">SharedFlow</span>  has a series of configuration values to be more flexible in the number of values we store,
         what happens when we are consuming those values more slowly than at the rate at which they are being emitted,
    and what is the maximum number of values that we want to store.</p>
    

    <p>Let's see how we would use these options. We go back to the previous example of Notes.
    In this case we use a <span class="negrita">MutableSharedFlow</span> </p>
    

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-val">val</span> state<span class="token operator">:</span>SharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span> <span class="token operator">=</span> _state<span class="token punctuation">.</span><span class="token function">asSharedFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>

    <p>We can see that the <span class="r-word">SharedFlows</span>  do not pass an initial value in the constructor.</p>
    
    <p>To change values we do not use the <span class="negrita">value</span> property, since it is not a single value, but we use the <span class="negrita">emit</span> function. </p>
    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">_state<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Title <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">,</span> <span class="token string">"Description <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>
    
    <p>To collect it we do it in the same way.</p>
    

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token operator">::</span>println<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>

    <p>For now, the complete code looks like this:</p>
    

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-data">data</span> <span class="token keyword keyword-class">class</span> <span class="token function">Note</span><span class="token punctuation">(</span>
    <span class="token keyword keyword-val">val</span> title<span class="token operator">:</span>String<span class="token punctuation">,</span>
    <span class="token keyword keyword-val">val</span> description<span class="token operator">:</span>String
<span class="token punctuation">)</span>

<span class="token keyword keyword-class">class</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//It would simulate a ViewModel but for this example is a simple class</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-val">val</span> state<span class="token operator">:</span>SharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span> <span class="token operator">=</span> _state<span class="token punctuation">.</span><span class="token function">asSharedFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-suspend">suspend</span> <span class="token keyword keyword-fun">fun</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword keyword-var">var</span> counter <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            _state<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Title <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">,</span> <span class="token string">"Description <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            counter<span class="token operator">++</span>
            <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">//This main function is just for running the example</span>
<span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Unit <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

    <span class="token keyword keyword-val">val</span> viewModel <span class="token operator">=</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    launch <span class="token punctuation">{</span>
        viewModel<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token operator">::</span>println<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>

<p>Output:</p>
<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">2</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">5</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">6</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">6</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">7</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">7</span><span class="token punctuation">)</span>
<span class="token operator">..</span><span class="token operator">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>At the moment it is working exactly the same as we had it before. Now let's see what happens if we start collecting after a second (line 7)</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-fun">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>Unit <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span>

    <span class="token keyword keyword-val">val</span> viewModel <span class="token operator">=</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    launch <span class="token punctuation">{</span>
        viewModel<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token operator">::</span>println<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

    <p>In this case we see that we have lost the first two values, it starts cocllecting from 3.</p>
    

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">5</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">..</span><span class="token operator">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>

<p>If we do not tell it anything, by default this <span class="r-word">SharedFlow</span>  will not store any value and therefore the old values are not emitted.</p>


<p>How can we configure this? If we go to the creation of the <span class="negrita">MutableSharedFlow</span> we will see that it has 3 arguments, 
    <span class="negrita">replay</span>, <span class="negrita">extraBufferCapacity</span> , <span class="negrita">onBufferOverflow</span>.</p>


<p>Let's see what each of them is for:</p>


<p><span class="r-word">replay</span> . Of integer type, we can tell it how many values we want it to store so that when we subscribe it
    starts with the first one stored. Default value is 0.
In this case we are going to set it to 1</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span><span class="token punctuation">(</span>
        replay <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>We see as a result, that before it issued us from 3, and when we put 1 it also recovers 2.</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">2</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>If instead of <span class="negrita">replay=1</span>  we set 2,
    then it will return the 2 stored, that is, the first and the second, then it already emits the third normally.</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    replay <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Output: </p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">2</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
    </section><br>


    <p><span class="r-word">extraBufferCapacity</span> . It will store values in a buffer. 
        Let's imagine that the values are being collected more slowly than they are being emitted.
    To do the test we will add a println to see when the values are being emitted (line 4).</p>
    

    <section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-while">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
    _state<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Title <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">,</span> <span class="token string">"Description <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Emitting Title= <span class="token interpolation variable">$counter</span>"</span><span class="token punctuation">)</span>
    counter<span class="token operator">++</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Also, when we collect we will set a delay of 1 second. For this we pass the lambda.</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Let's see the output</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">Emitting Title<span class="token operator">=</span> <span class="token number">1</span>
Emitting Title<span class="token operator">=</span> <span class="token number">2</span>
Emitting Title<span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">4</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">2</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">2</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">5</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">3</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">6</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">7</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br><br>

<p>We see that, since we have a <span class="negrita">replay</span>  of 2, the first 2 are broadcast without being collected, a third is broadcast and we collect the first, 
    once the first is collected a fourth is broadcast, once the second is collected a fifth is broadcast.
In other words, once the replay capacity is exhausted, no more are broadcast until one of the replays is collected, the broadcast function remains suspended.</p>


<p>To give it more storage capacity we use the <span class="r-word">extraBufferCapacity</span> parameter, 
    we are going to give it a value of two so that it stores 4 elements in total (2 replay + 2 extraBufferCapacity).</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    replay <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    extraBufferCapacity <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Output:</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">Emitting Title<span class="token operator">=</span> <span class="token number">1</span>
Emitting Title<span class="token operator">=</span> <span class="token number">2</span>
Emitting Title<span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">4</span>
Emitting Title<span class="token operator">=</span> <span class="token number">5</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">2</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">2</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">6</span>
Emitting Title<span class="token operator">=</span> <span class="token number">7</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">3</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">8</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">9</span>
<span class="token operator">..</span><span class="token operator">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>We see that it is emitting until the buffer is full, once it is full it is suspended until one is collected to be able to emit another.</p>


<p>It may be that we want the emit function to be suspended but simply discard the old or the new ones. We can do this with the third parameter,
     <span class="negrita">onBufferOverflow</span></p>


<p><span class="r-word">onBufferOverflow</span> . Its default value is configured with <span class="negrita">BuffeOverFlow.SUSPEND</span>, that is, if the buffer is full, 
    it is suspended and does not continue emitting until some element is collected.
Other values of this parameter are:</p>


<p><span class="negrita">BufferOverFlow.DROP_OLDEST</span> , that is, it eliminates the oldest ones in order to have room in the buffer and continue emitting.</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    replay <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    extraBufferCapacity <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    onBufferOverflow <span class="token operator">=</span> BufferOverflow<span class="token punctuation">.</span>DROP_OLDEST
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>If we put this value in our example we see the following output.</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">Emitting Title<span class="token operator">=</span> <span class="token number">5</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">2</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">2</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">6</span>
Emitting Title<span class="token operator">=</span> <span class="token number">7</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">3</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">3</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">8</span>
Emitting Title<span class="token operator">=</span> <span class="token number">9</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">10</span>
Emitting Title<span class="token operator">=</span> <span class="token number">11</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">6</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">6</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">12</span>
Emitting Title<span class="token operator">=</span> <span class="token number">13</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">8</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">8</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">14</span>
<span class="token operator">..</span><span class="token operator">..</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>If we look at element 5 (which was the oldest) it has not been collected, it has been discarded in order to emit element 10</p>


<p><span class="negrita">BufferOverFlow.DROP_LATEST</span>. In this case we will discard the new ones that enter until we consume the old ones.</p>


<p>Let's see the examples:</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> MutableSharedFlow<span class="token operator">&lt;</span>Note<span class="token operator">&gt;</span><span class="token punctuation">(</span>
    replay <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    extraBufferCapacity <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    onBufferOverflow <span class="token operator">=</span> BufferOverflow<span class="token punctuation">.</span>DROP_LATEST
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Output:</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">Emitting Title<span class="token operator">=</span> <span class="token number">8</span>
Emitting Title<span class="token operator">=</span> <span class="token number">9</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">4</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">4</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">10</span>
Emitting Title<span class="token operator">=</span> <span class="token number">11</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">5</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">5</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">12</span>
Emitting Title<span class="token operator">=</span> <span class="token number">13</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">6</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">6</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">14</span>
Emitting Title<span class="token operator">=</span> <span class="token number">15</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">7</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">7</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">16</span>
Emitting Title<span class="token operator">=</span> <span class="token number">17</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">8</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">8</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">18</span>
Emitting Title<span class="token operator">=</span> <span class="token number">19</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">10</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">10</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">20</span>
<span class="token operator">..</span><span class="token operator">..</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>In this case he had to discard the 9 to be able to issue the 10.</p>


<p>Another difference with the <span class="r-word">StateFlow</span>  is that if we emit the same value with the <span class="r-word">SharedFlow</span>
    it will emit it again, while with the <span class="r-word">StateFlow</span> it would not emit the same value again.</p>


<p>How do we make a <span class="r-word">SharedFlow</span>  behave exactly like a <span class="r-word">StateFlow</span>?</p>


<p>For this, we only store the last value, <span class="negrita">replay=1</span>, we don't give extra buffer capacity, and if we delete the oldest one.</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"> <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-val">val</span> _state <span class="token operator">=</span> <span class="token function">MutableSharedFlow</span><span class="token punctuation">(</span>
    replay <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    extraBufferCapacity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    onBufferOverflow <span class="token operator">=</span> BufferOverflow<span class="token punctuation">.</span>DROP_OLDEST
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>We would only need one thing, so that it behaves exactly like a <span class="r-word">StateFlow</span>, 
    and that is precisely that it does not emit again if the value does not change. </p>
<p>If we always emit the same value, it continues to be emitted.</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">_state<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token function">Note</span><span class="token punctuation">(</span><span class="token string">"Title 1"</span><span class="token punctuation">,</span> <span class="token string">"Description 1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Output:</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin"><span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">4</span>
Emitting Title<span class="token operator">=</span> <span class="token number">5</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">6</span>
Emitting Title<span class="token operator">=</span> <span class="token number">7</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">8</span>
Emitting Title<span class="token operator">=</span> <span class="token number">9</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>


<section class="marco-t inf">
    <span class="icono info"> </span> Remember that one data class is equal to another if its properties are the same.
    </section>
<section class="marco-b">
        
</section>
    
<p>We could check before emitting that the element has changed to emit it, but SharedFlow provides us with a function that allows us to do this. <span class="r-word">distinctUntilChanged()</span> .</p>


<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">viewModel<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">distinctUntilChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span> <span class="token punctuation">{</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Now we see that it continues to be issued but it does not collect it.</p>

<section><div class="code-toolbar"><pre class="language-kotlin line-numbers" tabindex="0"><code class="language-kotlin">Emitting Title<span class="token operator">=</span> <span class="token number">1</span>
Emitting Title<span class="token operator">=</span> <span class="token number">2</span>
Emitting Title<span class="token operator">=</span> <span class="token number">3</span>
<span class="token function">Note</span><span class="token punctuation">(</span>title<span class="token operator">=</span>Title <span class="token number">1</span><span class="token punctuation">,</span> description<span class="token operator">=</span>Description <span class="token number">1</span><span class="token punctuation">)</span>
Emitting Title<span class="token operator">=</span> <span class="token number">4</span>
Emitting Title<span class="token operator">=</span> <span class="token number">5</span>
Emitting Title<span class="token operator">=</span> <span class="token number">6</span>
Emitting Title<span class="token operator">=</span> <span class="token number">7</span>
Emitting Title<span class="token operator">=</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
</section><br>

<p>Obviously if what we want to do is that, it is best to use a <span class="r-word">StateFlow</span> ,
    we simply wanted to show that <span class="r-word">StateFlow</span>  is a specialization of <span class="r-word">SharedFlow</span>.</p>


    </section><!-- End section -->

    <!--*********************************************************WebGraphy***********************************************************-->
    <section class="apartado">
    <a name="sWebGraphy"></a>
    <h2>WebGraphy</h2>

    <ul>
        <li>
            <a class="enlace" target="_blank" href="https://developer.android.com/reference/androidx/lifecycle/LiveData">https://developer.android.com/reference/androidx/lifecycle/LiveData</a> 
        </li>
        <li><a class="enlace" target="_blank" href="https://github.com/koral--/android-gif-drawable">https://github.com/koral--/android-gif-drawable</a> </li>
        <li><a class="enlace" target="_blank" href="https://gerardfp.github.io/livedata/">Gerard's notes</a> </li>
        <li><a class="enlace" target="_blank" href="https://devexperto.com/flows-kotlin/">Flows</a> </li>
    </ul>
    
   
    </section><!-- End section -->

    <script src="./MVVM - Live Data - Flows_files/prism.js.descarga"></script>


</body></html>